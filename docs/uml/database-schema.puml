@startuml RTC_Database_Schema
title Schéma de Base de Données - Hello World RTC

hide circle
skinparam linetype ortho
skinparam backgroundColor #1a1a1a
skinparam package {
  BackgroundColor #2d2d2d
  BorderColor #4FDFFF
  FontColor #ffffff
}
skinparam entity {
  BackgroundColor #3d3d3d
  BorderColor #4FDFFF
  FontColor #ffffff
}
skinparam arrow {
  Color #4FDFFF
}

' ================== POSTGRESQL ==================
package "PostgreSQL (Source of Truth)" {

  entity "users" as users {
    + id : UUID <<PK>>
    --
    username : VARCHAR
    email : VARCHAR <<UNIQUE>>
    password_hash : VARCHAR
    status : ENUM
    avatar_url : VARCHAR?
    created_at : TIMESTAMP
  }

  entity "servers" as servers {
    + id : UUID <<PK>>
    --
    name : VARCHAR
    # owner_id : UUID <<FK>>
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
  }

  entity "server_members" as members {
    + server_id : UUID <<PK, FK>>
    + user_id : UUID <<PK, FK>>
    --
    role : ENUM(OWNER, ADMIN, MEMBER)
    joined_at : TIMESTAMP
  }

  entity "channels" as channels {
    + id : UUID <<PK>>
    --
    # server_id : UUID <<FK>>
    name : VARCHAR
    position : INT
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
  }

  entity "private_conversations" as dm {
    + id : UUID <<PK>>
    --
    # user1_id : UUID <<FK>>
    # user2_id : UUID <<FK>>
    created_at : TIMESTAMP
  }

  entity "invites" as invites {
    + id : UUID <<PK>>
    --
    # server_id : UUID <<FK>>
    code : VARCHAR <<UNIQUE>>
    # created_by : UUID <<FK>>
    expires_at : TIMESTAMP?
    max_uses : INT?
    uses_count : INT
    created_at : TIMESTAMP
  }

  entity "contacts" as contacts {
    + user_id : UUID <<PK, FK>>
    + contact_id : UUID <<PK, FK>>
    --
    status : ENUM(PENDING, ACCEPTED, BLOCKED)
    created_at : TIMESTAMP
  }

  ' ---- PostgreSQL Relations ----
  users   ||--o{ servers  : owns
  servers ||--o{ members  : has
  users   ||--o{ members  : joins
  servers ||--o{ channels : contains
  servers ||--o{ invites  : has
  users   ||--o{ invites  : creates
  users ||--o{ dm : participates
  users ||--o{ contacts : "user_id"
  users ||--o{ contacts : "contact_id"
}

' ================== MONGODB ==================
package "MongoDB (Message History)" #553333 {

  entity "channel_messages" as ch_msg {
    + _id : ObjectId
    --
    message_id : UUID <<UNIQUE>>
    channel_id : UUID
    server_id : UUID
    author_id : UUID
    content : TEXT
    created_at : TIMESTAMP
    edited_at : TIMESTAMP?
    deleted_at : TIMESTAMP?
    deleted_by : UUID?
  }

  entity "dm_messages" as dm_msg {
    + _id : ObjectId
    --
    message_id : UUID <<UNIQUE>>
    dm_id : UUID
    author_id : UUID
    content : TEXT
    created_at : TIMESTAMP
    edited_at : TIMESTAMP?
    deleted_at : TIMESTAMP?
    deleted_by : UUID?
  }
}

' ================== CROSS-DB LINKS ==================
channels ..> ch_msg : channel_id (logical)
servers  ..> ch_msg : server_id (logical)
users    ..> ch_msg : author_id (logical)
dm       ..> dm_msg : dm_id (logical)
users    ..> dm_msg : author_id (logical)

@enduml

